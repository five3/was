var last_elem, last_elem_style,div_inject_action;var flag,statue;var i = 1; var ifs, nw;var post_url = "http://was.testdoc.com"var inject_content = '<div id="was">\					  <div class="iframe_plug" id="menu">\							<div style="float:left; padding:0 5px;">\							<a id="inject_action" href="javascript:void(0);">Start Inpect</a>\							</div><div style="float:right; padding:0 10px;">\							<a id="plug_popup" href="javascript:void(0);" >Popup</a>\							<a id="plug_close" href="javascript:void(0);" >Close</a>\							</div>\					  </div>\					  <div id="show_attr" class="show_attr_css">\						<table class="inject_table" id="inject_table" border="0" cellpadding="2" cellspacing="2">\							<tr class="headline">\								<td class="c10" style="width:30%">Attribute</td>\								<td class="c10" style="width:50%">Value</td>\								<td class="c10" style="width:20%">Operate</td>\							</tr>\							<tr>\								<td class="c10"><label>ID:</label></td>\								<td class="c10"><input type="text" id="element_id"></td>\								<td class="c10"><a id="element_id_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\							<tr>\								<td class="c10"><label>Name:</label></td>\								<td class="c10"><input type="text" id="element_name"></td>\								<td class="c10"><a  id="element_name_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\							<tr>\								<td class="c10"><label>ClassName:</label></td>\								<td class="c10"><input type="text" id="element_classname"" ></td>\								<td class="c10"><a  id="element_classname_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\							<tr>\								<td class="c10"><label>Text:</label></td>\								<td class="c10"><input type="text" id="element_text"" ></td>\								<td class="c10"><a  id="element_text_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\							<tr>\								<td class="c10"><label>Value:</label></td>\								<td class="c10"><input type="text" id="element_value"" ></td>\								<td class="c10"><a  id="element_value_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\							<tr style="display:none">\								<td class="c10"><label>Link Text:</label></td>\								<td class="c10"><input type="text" id="element_link_text"></td>\								<td class="c10"><a id="element_link_text_add" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\							</tr>\						  </table>\					   </div>\						<div id="select_attr" class="select_attr_css">\							<table id="select_table" class="select_table" border="0">\								<tr class="headline">\									<td class="c10" style="width:30%">Attribute</td>\									<td class="c10" style="width:50%">Value</td>\									<td class="c10" style="width:20%">Operate</td>\								</tr>\							</table>\						</div>\					<div class="operate_area" id="operate_area">\							<div class="content" align="left">\								<label>User Define:</label>\								<p>\									<input id="customer_type" value="---Select---" class="ddap_cust_type" />\									<select id="customer_type_selector">\										<option value="---Select---">---Select---</option>\										<option value="index">index</option>\										<option value="xpath">xpath</option>\										<option value="css_selector">css selector</option>\									</select>\									<input type="text" maxlength="80" size="50" id="customer_value">\									<a class="link" href="javascript:void(0)" id="customer_define_type">add</a>\								</p>\								<hr></hr>\							</div>\							<div class="content" align="left">\								<label>User Action:</label>\								<p>\									<label>Name:</label>\									<input id="hightlight" type="text" maxlength="80" size="40">\									<a class="link">Load</a>\									<a class="link">hightlight</a>\								</p>\								<hr></hr>\							</div>\							<div class="content" align="left">\								<label>Element Save:</label>\								<p>\									<label>Project:</label>\									<select id="element_attribut_project">\										<option value="0">---Select---</option>\									</select>\									<label>Page:</label>\									<select id="element_attribut_page">\										<option value="0">---Select---</option>\									</select>\								</p>\							</div>\							<div class="content" align="left">\								<p>\									<label>Parent:</label>\									<select id="element_attribut_parent">\										<option value="0">---Select---</option>\									</select>\									<label>ElementType:</label>\									<input type="text" id="element_type">\									<input type="hidden" id="element_tagname">\								</p>\							</div>\							<div class="content" align="left">\								<p>\									<label>Name:</label>\									<input type="text" maxlength="80" size="50" id="element_attribut_name">\								</p>\							</div>\							<div class="content" align="left">\								<p>\									<label>memo:</label>\									<input type="text" maxlength="80" size="50" id="element_attribut_memo">\									<a id="element_attribut_save" class="save link">save</a>\								</p>\							</div>\						</div>\				  </div>';				  function inject(inject_type){	if (inject_type=='iframe'){		if($('#was_iframe').size()==0 && flag==undefined){			if (nw) {nw.close()};			var iframe = '<iframe src="about:blank" frameborder="0" name="was_iframe" id="was_iframe" style="border: 0px; visibility: visible; z-index: 2147483647; position: fixed; width: 100%; left: 0px; bottom: 0px; height: 271px; display: block;"></iframe>';			$("body").append(iframe);			ifs = document.getElementById('was_iframe').contentWindow.document;			registe_event();			$('#plug_popup', ifs.body).click(function(){inject('window');});		}else if(flag == 0 && $('#was_iframe').size() == 1){			$('#was_iframe').show();			flag = 1;		}else{			$('#was_iframe').hide();			flag = 0;		}	}else if (inject_type=='window'){		if (nw==undefined){			$('#was_iframe').hide();			nw = window.open("about:blank");			ifs = nw.document;				registe_event();		}	}}function registe_event(){	$(ifs.body).html(inject_content);	var resource_CSS = chrome.extension.getURL("inject.css");	$(ifs.head).html('<link href="'+resource_CSS+'" type="text/css" rel="stylesheet">');			var resource_Image_1 = chrome.extension.getURL("operate.gif");	$('#show_attr', ifs.body).find('a').css('background','url('+resource_Image_1+') no-repeat scroll -4px -4px transparent');	$("#inject_action", ifs.body).click(inject_div);	$("#plug_close", ifs.body).click(function(){$("#was_iframe").hide(); flag = 0;});	$("#customer_define_type", ifs.body).click(add_attribute);	add_data(post_url + "/project_listProject","element_attribut_project");	$('#element_attribut_project', ifs.body).bind("change",get_page);	$("#element_attribut_save", ifs.body).click(element_attribut_save);	$('#customer_type_selector', ifs.body).bind("change",update_element_type);	add_click();	flag=1;}inject('iframe');function inject_div(){	$("#show_attr", ifs.body).find('tr').show();	$("#select_table tr:not(:first)", ifs.body).empty();	if ($('#inject_action', ifs.body).text() == 'Stop Inpect'){		$('#inject_action', ifs.body).text('Start Inpect');		$('#cover_div', ifs.body).remove();		if (last_elem != undefined){					last_elem.style.border = last_elem_style;		}		$('#was_iframe').css('height',div_inject_action);	}else if($('#inject_action', ifs.body).text() == 'Start Inpect'){		div_inject_action = $('#was_iframe').height();		$('#was_iframe').css('height',"20px");		var cover_div = '<div id="cover_div" style="margin: 0px; padding: 0px; border: 0px; position: fixed; overflow: hidden; display: block; z-index: 2147483551; top: 0px; left: 0px; background-image: url(http://getfirebug.com/releases/lite/skin/xp/pixel_transparent.gif); width: 100%; background-position: initial initial; background-repeat: initial initial;"></div>';		if($('#cover_div').size()==0){			$('body').append(cover_div);		}else{			$('#cover_div').show();		}		$('#cover_div').css('height', '100%');		$('#cover_div').bind("click",onInspecting);		$('#cover_div').bind("mousemove",onInspectingover);		$('#inject_action', ifs.body).text('Stop Inpect');			}}function onInspecting(e){	$('#cover_div').hide();	$('#element_link_text', ifs.body).parent().parent().hide();	var targ = getElementFromPoint(e.clientX, e.clientY);	$('#was_iframe').css('height',div_inject_action);	$('#element_id', ifs.body).val(targ.id);	$('#element_name', ifs.body).val(targ.name);	$('#element_classname', ifs.body).val(targ.className);		$('#element_text', ifs.body).val(targ.innerText);	$('#element_value', ifs.body).val(targ.value);	$('#element_tagname', ifs.body).val(targ.tagName);	if(targ.tagName=="INPUT"){		$('#element_type', ifs.body).val(targ.type);	}else if(targ.tagName=="A"){		$('#element_link_text', ifs.body).val(targ.text);		$('#element_link_text', ifs.body).parent().parent().show();				$('#element_type', ifs.body).val(targ.tagName);	}else{		$('#element_type', ifs.body).val(targ.tagName);	}	removeElement();}function onInspectingover(e){	if (last_elem != undefined){				last_elem.style.border = last_elem_style;	}	$('#cover_div').hide();		var targ = getElementFromPoint(e.clientX, e.clientY);	last_elem = targ;	last_elem_style = targ.style.border;	$('#cover_div').show();	targ.style.border = 'thin inset blue';}	function getElementFromPoint(x, y){	if (false)	{		var scroll = this.getWindowScrollPosition();		return this.document.elementFromPoint(x + scroll.left, y + scroll.top);	}	else		return this.document.elementFromPoint(x, y);}function removeElement(){	last_elem.style.border = last_elem_style;	$('#cover_div').unbind("click",onInspecting);	$('#cover_div').unbind("mousemove",onInspectingover);	$('#inject_action', ifs.body).text('Start Inpect');}function add_click(){	$("#show_attr", ifs.body).find("a").each(function(){		$(this).click(add_attribute)	});}function add_attribute(){	switch($(this).attr("id"))	{		case 'element_id_add':			if($("#element_id", ifs.body).val()=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_id", ifs.body).val(),"ID");			$(this).parent().parent('tr').hide();		break;		case 'element_name_add':			if($("#element_name", ifs.body).val()=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_name", ifs.body).val(),"Name");			$(this).parent().parent('tr').hide();		break;		case 'element_classname_add':			if($("#element_classname", ifs.body).val()=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_classname", ifs.body).val(),"ClassName");			$(this).parent().parent('tr').hide();		break;		case 'element_text_add':			if($("#element_text", ifs.body).val()=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_text", ifs.body).val(),"Text");			$(this).parent().parent('tr').hide();		break;		case 'element_value_add':			if($("#element_value", ifs.body).val()=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_value", ifs.body).val(),"Value");			$(this).parent().parent('tr').hide();		break;				case 'element_link_text_add':			if($("#element_link_text", ifs.body).val=="")			{				alert("the Attribute is null!")				return			}			select_attribute($("#element_link_text", ifs.body).val(),"Link_Text");			$(this).parent().parent('tr').hide();		break;		case 'customer_define_type':			var customer_type = $("#customer_type", ifs.body).val().trim();			if(customer_type=="---Select---")			{				alert("no user define type selected!");				return;			}else if (customer_type==""){				alert("user define type can NOT Empty!");				return;							}			select_attribute($("#customer_value", ifs.body).val(),$("#customer_type", ifs.body).val());		break;	}}function select_attribute(text,id){	var resource_Image_2 = chrome.extension.getURL("operate_1.gif");	var tr='<tr>\			<td class="c10"><label>'+id+'</label></td>\			<td class="c10"><input type="text" id="select_attr_'+id+'" disabled="disabled" value="'+text+'"></td>\			<td class="c10"><a  id="element_'+id+'_delete" class="add_attribute" href="javascript:void(0);">&nbsp&nbsp&nbsp&nbsp</a></td>\			</tr>';	$("#select_table", ifs.body).append(tr);	$("#element_"+id+"_delete", ifs.body).css('background','url('+resource_Image_2+') no-repeat scroll -4px -4px transparent');	$("#element_"+id+"_delete", ifs.body).click(delete_attribute);}function delete_attribute(){	switch($(this).attr("id"))	{		case 'element_ID_delete':			$('#element_id_add', ifs.body).parent().parent('tr').show();		break;		case 'element_Name_delete':			$('#element_name_add', ifs.body).parent().parent('tr').show();		break;		case 'element_ClassName_delete':			$('#element_classname_add', ifs.body).parent().parent('tr').show();		break;		case 'element_Text_delete':			$('#element_text_add', ifs.body).parent().parent('tr').show();		break;		case 'element_Value_delete':			$('#element_value_add', ifs.body).parent().parent('tr').show();		break;				case 'element_Link_Text_delete':			$('#element_link_text', ifs.body).parent().parent('tr').show();		break;	}	$(this).parent().parent('tr').remove();}function element_attribut_save(){	if($("#element_attribut_project", ifs.body).val()=="0")	{		alert("please select Project!");		return;	}	if($("#element_attribut_page", ifs.body).val()=="0")	{		alert("please select Page!");		return;	}	if($("#element_attribut_name", ifs.body).val()=="")	{		alert("please enter element name!");		return;	}	if($("#element_attribut_memo", ifs.body).val()=="")	{		alert("please enter element memo!");		return;	}	if($("#select_table", ifs.body).find("input").length==0)	{		alert("please select element attribute!");		return;	}	var json={element:[	    	]};	var data = new Object();	var attribute = new Object();	$("#select_table", ifs.body).find("input").each(function(){		switch($(this).attr("id"))		{					case "select_attr_ClassName":				attribute.class_name = encodeURI($(this).val())			break			case "select_attr_Link_Text":				attribute.link_text = encodeURI($(this).val())			break			case "select_attr_css_selector":				attribute.css_selector = $(this).val()			break			default:				var attributes = $(this).attr("id").split("_");				var attr_type = attributes[attributes.length-1];				var eval_str = 'attribute.'+attr_type.toLowerCase()+'="'+$(this).val()+'"';				eval(eval_str);		}	});	attribute.tag_name=$("#element_tagname", ifs.body).val();	json.element.push(attribute);	data.project = $("#element_attribut_project", ifs.body).val();	data.page = $("#element_attribut_page", ifs.body).val();	data.element_name = encodeURI($("#element_attribut_name", ifs.body).val());	data.memo = encodeURI($("#element_attribut_memo", ifs.body).val());	data.element_type = $("#element_type", ifs.body).val();	if($("#element_attribut_parent", ifs.body).val()!="0")	{		data.parent = $("#element_attribut_parent", ifs.body).val();	}	json.element.push(data);	send_element(json);}function send_element(json){	if(window.XMLHttpRequest)  	{  		req=new XMLHttpRequest();  	}else if(window.ActiveXObject)  	{  		req=new ActiveXObject("Microsoft.XMLHTTP");  	}  	if(req)  	{  		req.open("post", post_host + "/ddap_platform/element_save", true);  		req.onreadystatechange=function(){  			if (req.readyState==4 && req.status==200)			{				attend(req.responseText);			}  		};  		req.send(JSON.stringify(json));  	}}function attend(responseText){	alert(responseText);}function add_data(url,name){	if(window.XMLHttpRequest)	{		req=new XMLHttpRequest();	}else if(window.ActiveXObject)	{		req=new ActiveXObject("Microsoft.XMLHTTP");	}if(req)	{		req.open("post",url,true);		req.onreadystatechange=function(){add_information(name);};		req.send(null);	}}function add_information(e){	if(req.readyState==4)	{		if(req.status==200)		{			$("#"+e).empty();			$("#"+e).append('<option value="0">---Select---</option>');			var json = eval(req.responseText);			for (var i=0;i<json.length;i++)			{				$("#"+e).append('<option value="'+json[i].id+'">'+json[i].name+'</option>');			}				}		else		{			alert("Not able to retrieve description"+req.statusText);		}	}}function get_page(){	var value = $('#element_attribut_project', ifs.body).val();	if(value == "0")	{		return;	}	add_data(post_url + "/project_getProjectPage?id="+value,"element_attribut_page");	$('#element_attribut_page', ifs.body).bind("change",get_element);}function get_element(){	var value = $('#element_attribut_page', ifs.body).val();	if(value == "0"){		return;	}	add_data(post_url + "/element_getPageElement?page_id="+value,"element_attribut_parent");}function update_element_type(){	$('#customer_type', ifs.body).val(this.value);}